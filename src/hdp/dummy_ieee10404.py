# -*- coding: utf-8

#######################################################################
# Copyright 2010 Signove Corporation - All rights reserved.
# Contact: Signove Corporation (contact@signove.com)
#
# This library is free software; you can redistribute it and/or modify
# it under the terms of version 2.1 of the GNU Lesser General Public
# License as published by the Free Software Foundation.
#
# This library is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Lesser General Public License for more details.
#
# You should have received a copy of the GNU Lesser General Public
# License along with this library; if not, write to the
# Free Software Foundation, Inc., 59 Temple Place, Suite 330,
# Boston, MA 02111-1307  USA
#
# If you have questions regarding the use of this file, please contact
# Signove at contact@signove.com.
#######################################################################

#From IEEE Standard 11073-10404 page 62

from hdp_utils import *
from random import randint

assoc_resp_msg = (
	0xe3, 0x00, #APDU CHOICE Type(AareApdu)
	0x00, 0x2c, #CHOICE.length = 44
	0x00, 0x00, #result=accept (known config)
	0x50, 0x79, #data-proto-id = 20601
	0x00, 0x26, #data-proto-info length = 38
	0x80, 0x00, 0x00, 0x00, #protocolVersion
	0x80, 0x00, #encoding rules = MDER
	0x80, 0x00, 0x00, 0x00, #nomenclatureVersion
	0x00, 0x00, 0x00, 0x00, #functionalUnits, normal Association
	0x80, 0x00, 0x00, 0x00, #systemType = sys-type-manager
	0x00, 0x08, #system-id length = 8 and value (manufacturer- and device- specific) 
	0x88, 0x77, 0x66, 0x55, 0x44, 0x33, 0x22, 0x11,
	0x00, 0x00, #Manager's response to config-id is always 0
	0x00, 0x00, #Manager's response to data-req-mode-flags is always 0
	0x00, 0x00, #data-req-init-agent-count and data-req-init-manager-count are always 0
	0x00, 0x00, 0x00, 0x00, #optionList.count = 0 | optionList.length = 0
	)

assoc_resp_msg_unknown_config = (
	0xe3, 0x00, #APDU CHOICE Type(AareApdu)
	0x00, 0x2c, #CHOICE.length = 44
	0x00, 0x03, #result=accept (unknown config)
	0x50, 0x79, #data-proto-id = 20601
	0x00, 0x26, #data-proto-info length = 38
	0x80, 0x00, 0x00, 0x00, #protocolVersion
	0x80, 0x00, #encoding rules = MDER
	0x80, 0x00, 0x00, 0x00, #nomenclatureVersion
	0x00, 0x00, 0x00, 0x00, #functionalUnits, normal Association
	0x80, 0x00, 0x00, 0x00, #systemType = sys-type-manager
	0x00, 0x08, #system-id length = 8 and value (manufacturer- and device- specific) 
	0x88, 0x77, 0x66, 0x55, 0x44, 0x33, 0x22, 0x11,
	0x00, 0x00, #Manager's response to config-id is always 0
	0x00, 0x00, #Manager's response to data-req-mode-flags is always 0
	0x00, 0x00, #data-req-init-agent-count and data-req-init-manager-count are always 0
	0x00, 0x00, 0x00, 0x00, #optionList.count = 0 | optionList.length = 0
	)

release_response = (0xe5, 0x00, 0x00, 0x02, 0x00, 0x00)

def parse_message(msg, unknown_config=False):
	resp = ()

	print "IEEE opcode received: %x" % int(msg[0])

	if int(msg[0]) == 0xe2:
		print 'IEEE association request'
		if unknown_config:
			resp = assoc_resp_msg_unknown_config
		else:
			resp = assoc_resp_msg

	elif int(msg[0]) == 0xe7:
		print 'IEEE agent data: %x %x' % (int(msg[18]), int(msg[19]))
		# FIXME depending on fixed position, not very robust
		if int(msg[18]) == 0x0d and int(msg[19]) == 0x1c:
			# MDC_NOTI_CONFIG
			resp = (
				0xe7, 0x00, #APDU CHOICE Type(PrstApdu)
				0x00, 0x16, #CHOICE.length = 22
				0x00, 0x14, #OCTET STRING.length = 20
				int(msg[6]), int(msg[7]), #invoke-id (mirrored from invocation) 
				0x02, 0x01, #CHOICE(Remote Operation Response | Confirmed Event Report)
				0x00, 0x0e, #CHOICE.length = 14
				0x00, 0x00, #obj-handle = 0 (MDS object)
				0x00, 0x00, 0x00, 0x00, #currentTime = 0
				0x0d, 0x1c, #event-type = MDC_NOTI_CONFIG
				0x00, 0x04, #event-reply-info.length = 4
				0x40, 0x00, # ConfigReportRsp.config-report-id=0x4000
				0x00, 0x00  # ConfigReportRsp.config-result = accepted-config
				)
		else:
			# assuming MDC_NOTI_SCAN_REPORT_FIXED
			resp = (
				0xe7, 0x00, #APDU CHOICE Type(PrstApdu)
				0x00, 0x12, #CHOICE.length = 18
				0x00, 0x10, #OCTET STRING.length = 16
				int(msg[6]), int(msg[7]), #invoke-id (mirrored from invocation) 
				0x02, 0x01, #CHOICE(Remote Operation Response | Confirmed Event Report)
				0x00, 0x0a, #CHOICE.length = 10
				0x00, 0x00, #obj-handle = 0 (MDS object)
				0x00, 0x00, 0x00, 0x00, #currentTime = 0
				0x0d, 0x1d, #event-type = MDC_NOTI_SCAN_REPORT_FIXED
				0x00, 0x00, #event-reply-info.length = 0
				)

			# FIXME depending on fixed positions, not very robust
			print '\nSpO2 Level: %d, Beats/second: %d\n' % \
				(int(msg[35]), int(msg[49]))

	elif int(msg[0]) == 0xe4:
		resp = release_response

	return resp


def parse_message_str(msg, unknown_config=False):
	return b2s(parse_message(s2b(msg), unknown_config))


# Dumped from Nonin Oximeter
sample_assoc_request = (0xe2, 0x0, 0x0, 0x32, 0x80, 0x0, 0x0, 0x0, 0x0, 0x1, 0x0, 0x2a, 0x50, 0x79, 0x0, 0x26, 0x80, 0x0, 0x0, 0x0, 0x80, 0x0, 0x80, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x80, 0x0, 0x0, 0x0, 0x8, 0x0, 0x1c, 0x5, 0x1, 0x0, 0x0, 0x28, 0x85, 0x1, 0x91, 0x0, 0x1, 0x1, 0x0, 0x0, 0x0, 0x0, 0x0)


# Dumped from Nonin Oximeter
sample_indication = [0xe7, 0x0, 0x0, 0x36, 0x0, 0x34, 0x80, 0x0, 0x1, 0x0, 0x0, 0x2e, 0x0, 0x0, 0x0, 0x8, 0xa3, 0x40, 0xd, 0x1d, 0x0, 0x24, 0xf0, 0x0, 0x0, 0x0, 0x0, 0x2, 0x0, 0x1c, 0x0, 0x1, 0x0, 0xa, 0x0, 0x62, 0x20, 0x7, 0x10, 0x1, 0x8, 0x31, 0x42, 0x0, 0x0, 0xa, 0x0, 0xa, 0x0, 0x69, 0x20, 0x7, 0x10, 0x1, 0x8, 0x31, 0x42, 0x0]


# Dumped from Nonin Oximeter
sample_config = [0xe7, 0x0, 0x0, 0x88, 0x0, 0x86, 0x32, 0x12, 0x1, 0x1, 0x0, 0x80, 0x0, 0x0, 0x0, 0xd, 0x1c, 0xe0, 0xd, 0x1c, 0x0, 0x76, 0x1, 0x91, 0x0, 0x2, 0x0, 0x70, 0x0, 0x6, 0x0, 0x1, 0x0, 0x5, 0x0, 0x30, 0x9, 0x2f, 0x0, 0x4, 0x0, 0x2, 0x4b, 0xb8, 0xa, 0x46, 0x0, 0x2, 0x40, 0x40, 0x9, 0x96, 0x0, 0x2, 0x2, 0x20, 0xa, 0x55, 0x0, 0xc, 0x0, 0x2, 0x0, 0x8, 0xa, 0x4c, 0x0, 0x2, 0x9, 0x87, 0x0, 0x8, 0xa, 0x61, 0x0, 0x8, 0x0, 0x1, 0x0, 0x4, 0x0, 0x2, 0x4c, 0x3c, 0x0, 0x6, 0x0, 0xa, 0x0, 0x5, 0x0, 0x30, 0x9, 0x2f, 0x0, 0x4, 0x0, 0x2, 0x48, 0x1a, 0xa, 0x46, 0x0, 0x2, 0x40, 0x40, 0x9, 0x96, 0x0, 0x2, 0xa, 0xa0, 0xa, 0x55, 0x0, 0xc, 0x0, 0x2, 0x0, 0x8, 0xa, 0x4c, 0x0, 0x2, 0x9, 0x87, 0x0, 0x8, 0xa, 0x61, 0x0, 0x8, 0x0, 0x1, 0x0, 0x4, 0x0, 0x2, 0x4c, 0x3c]

def make_assoc():
	return sample_assoc_request

def make_assoc_str():
	return b2s(make_assoc())

def make_sample():
	ind = sample_indication[:]
	ind[35] = randint(90, 100)
	ind[49] = randint(55, 105)
	return tuple(ind)

def make_sample_str():
	return b2s(make_sample())

def make_config():
	return sample_config

def make_config_str():
	return b2s(make_config())
